services:
  bluesky-pds:
    image: r.clv.zone/e2eorg/bluesky-pds
    container_name: bluesky_pds
    restart: unless-stopped
    # No external port exposure - accessed via nginx
    environment:
      # PDS Configuration
      PDS_HOSTNAME: pds.clouve.dev:8443
      PDS_DATA_DIRECTORY: /pds
      PDS_BLOBSTORE_DISK_LOCATION: /pds/blocks
      PDS_DID_PLC_URL: https://plc.directory
      PDS_BSKY_APP_VIEW_URL: https://api.bsky.app
      PDS_BSKY_APP_VIEW_DID: did:web:api.bsky.app
      PDS_REPORT_SERVICE_URL: https://mod.bsky.app
      PDS_REPORT_SERVICE_DID: did:plc:ewvi7nxzyoun6zhxrhs64oiz
      PDS_CRAWLERS: https://bsky.network

      # Admin Configuration - Auto-generated by entrypoint if not set
      # PDS_ADMIN_PASSWORD: # Auto-generated on first run
      # PDS_JWT_SECRET: # Auto-generated on first run
      # PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX: # Auto-generated on first run
      # PDS_DPOP_SECRET: # Auto-generated on first run

      # Email Configuration (optional)
      PDS_EMAIL_SMTP_URL: ""
      PDS_EMAIL_FROM_ADDRESS: ""

      # Feature Flags
      PDS_INVITE_REQUIRED: "0"
      LOG_ENABLED: "1"
    volumes:
      - pds_data:/pds
    networks:
      - bluesky_network
    healthcheck:
      test:
        - CMD-SHELL
        - wget --spider -q http://localhost:3000/xrpc/_health
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  nginx:
    image: nginx:alpine
    container_name: bluesky_nginx
    restart: unless-stopped
    command: ["/bin/sh", "-c", "apk add --no-cache curl && rm -f /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"]
    volumes:
      - ./tunnel/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./tunnel/cert.crt:/etc/nginx/ssl/cert.crt:ro
      - ./tunnel/cert.key:/etc/nginx/ssl/cert.key:ro
    networks:
      - bluesky_network
    depends_on:
      - bluesky-pds
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost/xrpc/_health"]
      interval: 10s
      timeout: 5s
      retries: 5

  rathole-client:
    image: clouve/rathole-client
    container_name: bluesky_rathole
    restart: unless-stopped
    volumes:
      - ./tunnel/client.toml:/etc/rathole/client.toml:ro
    networks:
      - bluesky_network
    depends_on:
      - nginx
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f rathole || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  pds_data:
    driver: local

networks:
  bluesky_network:
    driver: bridge


